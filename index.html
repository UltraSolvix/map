<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة GPS احترافية</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
#map { width: 100%; height: 100vh; }
.info-box {
  position: absolute; top: 10px; right: 10px;
  background: rgba(255,255,255,0.95); padding: 15px 20px; border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; max-width: 320px; line-height: 1.5;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="info-box" id="infoBox">
  <strong>اسم المكان:</strong> <span id="placeName">جارٍ التحديد...</span><br>
  <strong>الدقة:</strong> <span id="accuracy">-</span> متر<br>
  <strong>خط العرض:</strong> <span id="lat">-</span><br>
  <strong>خط الطول:</strong> <span id="lng">-</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ======== إعداد الخريطة ========
const map = L.map('map', { zoomControl: true, dragging: true }).setView([0, 0], 17);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// ======== أيقونة السهم ========
const arrowIcon = L.divIcon({
    className: '',
    html: `<div style="transform: rotate(0deg);">
             <svg width="40" height="40" viewBox="0 0 64 64">
               <circle cx="32" cy="32" r="12" fill="blue" fill-opacity="0.3"/>
               <line x1="32" y1="32" x2="32" y2="8" stroke="red" stroke-width="4"/>
               <polygon points="32,4 28,12 36,12" fill="red"/>
             </svg>
           </div>`,
    iconSize: [40, 40],
    iconAnchor: [20, 20]
});

let userMarker = L.marker([0,0], {icon: arrowIcon}).addTo(map);
let accuracyCircle = L.circle([0,0], {radius: 0, color:'blue', fillColor:'blue', fillOpacity:0.1}).addTo(map);
let laserLine = L.polyline([[0,0],[0,0]], {color:'red', weight:2, opacity:0.5}).addTo(map);

let followUser = true;

// ======== عناصر واجهة المستخدم ========
const latElem = document.getElementById('lat');
const lngElem = document.getElementById('lng');
const accElem = document.getElementById('accuracy');
const placeElem = document.getElementById('placeName');

// ======== تتبع الموقع ========
let positions = [];
const maxSamples = 5;

if (!navigator.geolocation) { alert("متصفحك لا يدعم تحديد الموقع."); }

navigator.geolocation.watchPosition(handlePosition, handleError, {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 20000
});

// ======== التحكم في تتبع المستخدم ========
map.on('dragstart', () => { followUser = false; });

// ======== دوال ========
function handlePosition(position) {
    const { latitude, longitude, accuracy, heading } = position.coords;

    // جمع القراءات لتحسين الدقة
    positions.push({lat: latitude, lng: longitude, acc: accuracy});
    if (positions.length > maxSamples) positions.shift();

    const avgLat = positions.reduce((sum, p) => sum + p.lat, 0)/positions.length;
    const avgLng = positions.reduce((sum, p) => sum + p.lng, 0)/positions.length;
    const avgAcc = positions.reduce((sum, p) => sum + p.acc, 0)/positions.length;

    // تحديث عناصر info
    latElem.textContent = avgLat.toFixed(7);
    lngElem.textContent = avgLng.toFixed(7);
    accElem.textContent = avgAcc.toFixed(2);

    // تحديث موقع السهم
    userMarker.setLatLng([avgLat, avgLng]);
    accuracyCircle.setLatLng([avgLat, avgLng]).setRadius(avgAcc);
    const rotation = heading !== null ? heading : 0;
    if(userMarker.getElement()) userMarker.getElement().style.transform = `rotate(${rotation}deg)`;

    // خط الليزر للأمام
    const laserLength = 0.0005; // تقريبياً 50 متر
    const rad = rotation * Math.PI / 180;
    const endLat = avgLat + laserLength * Math.cos(rad);
    const endLng = avgLng + laserLength * Math.sin(rad);
    laserLine.setLatLngs([[avgLat, avgLng],[endLat, endLng]]);

    // متابعة المستخدم إذا لم يحرك الخريطة
    if (followUser) { map.setView([avgLat, avgLng]); }

    // اسم المكان
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${avgLat}&lon=${avgLng}&format=json`)
    .then(res => res.json())
    .then(data => { placeElem.textContent = data.display_name || "غير متاح"; })
    .catch(err => placeElem.textContent = "خطأ في جلب الاسم");
}

function handleError(err){
    console.error(err);
    alert("تعذر تحديد الموقع: " + err.message);
}
</script>
</body>
</html>
