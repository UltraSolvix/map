<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ©</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css"/>

<style>
:root {
  --accent: #007bff;
  --green: #28a745;
  --red: #dc3545;
}
html, body {
  height: 100%;
  margin: 0;
  font-family: "Cairo", sans-serif;
  background: #f4f6f9;
}
#map {
  height: 100vh;
  width: 100%;
}
#start-btn {
  position: absolute;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: #fff;
  font-size: 20px;
  font-weight: bold;
  border: none;
  border-radius: 12px;
  padding: 14px 28px;
  box-shadow: 0 4px 14px rgba(0,0,0,0.2);
  cursor: pointer;
  z-index: 1500;
}
#popup {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1600;
}
#popup-content {
  background: #fff;
  padding: 22px 24px;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  text-align: center;
}
#popup-content h2 {
  margin: 0 0 10px;
  font-size: 22px;
  color: var(--accent);
}
#destination {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  font-size: 16px;
  margin-top: 10px;
  color: #000;
}
#suggestions {
  text-align: right;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 0 0 8px 8px;
  margin-top: 2px;
  max-height: 150px;
  overflow-y: auto;
  display: none;
}
#suggestions div {
  padding: 8px 10px;
  cursor: pointer;
  color: #000;
}
#suggestions div:hover {
  background: #e9f3ff;
}
#confirm-btn {
  margin-top: 12px;
  background: var(--green);
  color: #fff;
  font-size: 18px;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  cursor: pointer;
}
#cancel-btn {
  margin-top: 8px;
  background: var(--red);
  color: #fff;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
}
#status {
  position: absolute;
  top: 14px;
  left: 14px;
  background: rgba(255,255,255,0.9);
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 1500;
}
</style>
</head>
<body>

<div id="map"></div>
<button id="start-btn">ğŸš— Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©</button>
<div id="status">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</div>

<!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="popup">
  <div id="popup-content">
    <h2>Ø¥Ù„Ù‰ Ø£ÙŠÙ†ØŸ</h2>
    <input id="destination" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ø¥Ù„ÙŠÙ‡">
    <div id="suggestions"></div>
    <button id="confirm-btn">ØªÙ…</button><br>
    <button id="cancel-btn">Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
const map = L.map('map').setView([26.8, 30.8], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

let lastPos = null;
let marker = null;
let routingControl = null;
const statusEl = document.getElementById('status');
const popup = document.getElementById('popup');
const startBtn = document.getElementById('start-btn');
const confirmBtn = document.getElementById('confirm-btn');
const cancelBtn = document.getElementById('cancel-btn');
const destinationInput = document.getElementById('destination');
const suggestionsBox = document.getElementById('suggestions');

/* ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
function handleGPS(lat, lon, acc){
  lastPos = { lat, lon, acc };
  if (!marker){
    marker = L.circleMarker([lat,lon], {radius:8, color:'#007bff', fillOpacity:1}).addTo(map);
  } else marker.setLatLng([lat,lon]);
  map.setView([lat,lon], 15);
  statusEl.textContent = `ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ Ù…Ø­Ø¯Ø¯ Ø¨Ø¯Ù‚Ø© ${Math.round(acc)} Ù…ØªØ±`;
}
function startTracking(){
  if (!navigator.geolocation){
    statusEl.textContent = 'âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹';
    return;
  }
  navigator.geolocation.watchPosition(p=>{
    handleGPS(p.coords.latitude, p.coords.longitude, p.coords.accuracy);
  }, ()=>{
    statusEl.textContent = 'âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
  }, { enableHighAccuracy:true, maximumAge:0, timeout:10000 });
}
startTracking();

/* Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„ÙˆØ¬Ù‡Ø© */
async function fetchSuggestions(query){
  if (!query.trim()) { suggestionsBox.style.display = 'none'; return; }
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query+', Ù…ØµØ±')}&countrycodes=eg&limit=6&accept-language=ar`;
  const res = await fetch(url);
  const data = await res.json();
  suggestionsBox.innerHTML = '';
  if (!data.length){ suggestionsBox.style.display='none'; return; }
  data.forEach(p=>{
    const div = document.createElement('div');
    div.textContent = p.display_name.split(',').slice(0,3).join(', ');
    div.onclick = ()=>{
      destinationInput.value = p.display_name;
      destinationInput.dataset.lat = p.lat;
      destinationInput.dataset.lon = p.lon;
      suggestionsBox.style.display='none';
    };
    suggestionsBox.appendChild(div);
  });
  suggestionsBox.style.display='block';
}
destinationInput.addEventListener('input', e=>{
  delete destinationInput.dataset.lat;
  delete destinationInput.dataset.lon;
  fetchSuggestions(e.target.value);
});
document.addEventListener('click', e=>{
  if (!destinationInput.contains(e.target) && !suggestionsBox.contains(e.target))
    suggestionsBox.style.display='none';
});

/* ÙØªØ­/ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
startBtn.onclick = ()=> popup.style.display = 'flex';
cancelBtn.onclick = ()=> popup.style.display = 'none';

/* Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± */
async function computeRoute(startLatLng, endLatLng){
  if (routingControl) map.removeControl(routingControl);
  routingControl = L.Routing.control({
    waypoints: [L.latLng(startLatLng.lat, startLatLng.lon), L.latLng(endLatLng.lat, endLatLng.lon)],
    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1/' }),
    lineOptions: { styles: [{color:'#ff0000', weight:6, opacity:0.9}] },
    createMarker: ()=> null,
    addWaypoints: false,
    draggableWaypoints: false,
    showAlternatives: false,
  }).addTo(map);

  routingControl.on('routesfound', e=>{
    const r = e.routes[0];
    const km = (r.summary.totalDistance/1000).toFixed(2);
    const min = Math.round(r.summary.totalTime/60);
    statusEl.textContent = `ğŸš— Ø§Ù„Ù…Ø³Ø§ÙØ©: ${km} ÙƒÙ… | Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${min} Ø¯Ù‚ÙŠÙ‚Ø©`;
    setTimeout(()=> document.querySelectorAll('.leaflet-routing-container').forEach(c=>c.remove()),100);
  });
}

/* Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªÙ…" */
confirmBtn.onclick = async ()=>{
  try{
    if (!lastPos) return alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¹Ø¯!');
    const dest = destinationInput.value.trim();
    if (!dest) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙˆØ¬Ù‡Ø© Ø£ÙˆÙ„Ø§Ù‹');

    let endLatLng;
    if (destinationInput.dataset.lat && destinationInput.dataset.lon){
      endLatLng = { lat: destinationInput.dataset.lat, lon: destinationInput.dataset.lon };
    } else {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dest+', Ù…ØµØ±')}&countrycodes=eg&limit=1&accept-language=ar`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.length) return alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¬Ù‡Ø©');
      endLatLng = { lat: data[0].lat, lon: data[0].lon };
    }

    popup.style.display = 'none';
    statusEl.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±...';
    await computeRoute(lastPos, endLatLng);
  }catch(e){
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
  }
};
</script>
</body>
</html>
