<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة حرة ثلاثية الأبعاد</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.22.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.22.0/mapbox-gl.css" rel="stylesheet" />
<style>
body { margin:0; padding:0; height:100%; font-family:sans-serif; }
#mapContainer { position:absolute; top:0; bottom:0; width:100%; }
.place-name {
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.85);
    padding:10px 20px;
    border-radius:15px;
    font-size:16px;
    font-weight:bold;
    color:#2c3e50;
    z-index:1000;
    pointer-events:none;
    box-shadow:0 4px 8px rgba(0,0,0,0.2);
    backdrop-filter: blur(5px);
}
</style>
</head>
<body>

<div id="mapContainer"></div>
<div class="place-name" id="placeName">جاري تحديد موقعك...</div>

<script>
mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN';

const map = new mapboxgl.Map({
    container: 'mapContainer',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [31.2357,30.0444],
    zoom: 17,
    pitch: 45,
    bearing: 0, // اتجاه الشمال
    dragRotate: true, // يسمح بتدوير الخريطة
    touchZoomRotate: true // يسمح بالتكبير والتدوير باللمس
});

let userMarker = null;
let userCoords = null;

if(navigator.geolocation){
    navigator.geolocation.watchPosition(async (pos)=>{
        userCoords = [pos.coords.longitude, pos.coords.latitude];

        // إضافة/تحديث العلامة
        if(!userMarker){
            userMarker = new mapboxgl.Marker().setLngLat(userCoords).addTo(map);
        } else {
            userMarker.setLngLat(userCoords);
        }

        // تحديث اسم المكان فقط
        try{
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userCoords[1]}&lon=${userCoords[0]}&zoom=18&accept-language=ar`);
            const data = await res.json();
            document.getElementById('placeName').textContent = data.display_name || 'غير متاح';
        }catch{
            document.getElementById('placeName').textContent = 'غير متاح';
        }

        // تحريك الخريطة بسلاسة خلف العلامة إذا لم تتفاعل
        if(!userInteracted) map.easeTo({center: userCoords, duration: 1000});

    }, (err)=>{ console.error('خطأ في تحديد الموقع:', err); }, { enableHighAccuracy:true, maximumAge:0, timeout:5000 });
}

// اكتشاف تفاعل المستخدم
let userInteracted = false;
map.on('dragstart', ()=>{ userInteracted = true; });
map.on('rotate', ()=>{ userInteracted = true; });
map.on('zoomstart', ()=>{ userInteracted = true; });

</script>
</body>
</html>
