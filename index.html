<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { height: 100%; }
    #location {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.7);
      padding: 8px 14px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
      font-family: "Cairo", sans-serif;
      font-size: 14px;
      color: black;
      direction: rtl;
      z-index: 9999;
    }
    #recenter-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9999;
    }
    #recenter-btn:hover {
      background: rgba(255, 255, 255, 1);
    }
    #recenter-btn::before {
      content: 'ğŸ¯';
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="location">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="address">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span></div>
  <div id="map"></div>
  <div id="recenter-btn" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙŠ"></div>

  <script>
    const map = L.map('map').setView([30.0444, 31.2357], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; Ø®Ø±ÙŠØ·Ø© Ù…Ù† OpenStreetMap'
    }).addTo(map);

    let marker;
    let lastUpdate = 0;
    let lastLat, lastLon;

    async function getAccurateLocationName(lat, lon) {
      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=20&addressdetails=1&accept-language=ar`,
          { headers: { 'User-Agent': 'MyMapApp/1.0 (contact@example.com)' } }
        );
        const data = await res.json();
        const addr = data.address || {};

        const street = addr.road || addr.pedestrian || addr.highway || "";
        const area = addr.neighbourhood || addr.suburb || addr.village || "";
        const city = addr.town || addr.city || addr.county || "";
        let name = street && city ? `${street}ØŒ ${city}` :
                   street && area ? `${street}ØŒ ${area}` :
                   area && city ? `${area}ØŒ ${city}` :
                   data.display_name || "Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

        if (name.length > 60) name = name.split("ØŒ").slice(0, 3).join("ØŒ ");
        return name;
      } catch (err) {
        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:", err);
        return "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
      }
    }

    function smoothMoveMarker(lat, lon, duration = 1000) {
      if (!marker) {
        marker = L.marker([lat, lon]).addTo(map);
      } else {
        const startLat = lastLat || lat;
        const startLon = lastLon || lon;
        const steps = 10;
        const deltaLat = (lat - startLat) / steps;
        const deltaLon = (lon - startLon) / steps;
        let step = 0;

        function animate() {
          if (step <= steps) {
            marker.setLatLng([startLat + deltaLat * step, startLon + deltaLon * step]);
            step++;
            setTimeout(animate, duration / steps);
          } else {
            marker.setLatLng([lat, lon]);
          }
        }
        animate();
      }
      lastLat = lat;
      lastLon = lon;
    }

    function updatePosition(lat, lon) {
      const now = Date.now();
      if (now - lastUpdate >= 1000) {
        smoothMoveMarker(lat, lon);
        lastUpdate = now;
      }
    }

    navigator.geolocation.watchPosition(
      async pos => {
        const { latitude, longitude, accuracy } = pos.coords;
        if (accuracy <= 3) { // Strict 3-meter accuracy
          updatePosition(latitude, longitude);
          if (!map._userLocated) {
            map.setView([latitude, longitude], 18);
            map._userLocated = true;
          }
          const name = await getAccurateLocationName(latitude, longitude);
          document.getElementById("address").textContent = name;
        }
      },
      err => {
        console.error(err);
        document.getElementById("address").textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
      },
      {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
      }
    );

    document.getElementById("recenter-btn").addEventListener("click", () => {
      if (lastLat && lastLon) {
        map.setView([lastLat, lastLon], 18);
      }
    });
  </script>
</body>
</html>
