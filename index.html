<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تحديد الموقع الاحترافي</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css"
 integrity="sha256-sA+z0YefPZ1t5gQ2n3nXzOIvPp5r7Wc9p3rV0sA0hYQ="
 crossorigin=""/>

<style>
body {
    margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; 
    background: #f5f5f5; text-align:center;
}

#map {
    height: 95vh;
    width: 100%;
}

#locationName {
    position: absolute;
    top: 10px; left: 50%; transform: translateX(-50%);
    background: rgba(255,255,255,0.9);
    padding: 10px 20px; border-radius: 10px;
    font-size: 18px; font-weight: bold;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}

.leaflet-marker-icon.arrow-marker {
    transform-origin: center;
    transition: transform 0.3s ease;
}
</style>
</head>
<body>

<div id="locationName">جارٍ تحديد الموقع...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"
 integrity="sha256-0VZ4v8fCw8Zt6w0QGxk3UjJvHVb+6wQ4LYzF1yA2Z3U="
 crossorigin=""></script>

<script>
// إعداد الخريطة
const map = L.map('map', { zoomControl: true }).setView([0,0], 17);
let userMarker = null;

// طبقة OpenStreetMap مع تفاصيل عالية
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

// عنصر عرض اسم المكان
const locationNameDiv = document.getElementById('locationName');

// أيقونة السهم مع شعاع ليزر أمامه
const arrowIcon = L.divIcon({
    className: 'arrow-marker',
    html: `<div style="position:relative; width:30px; height:30px;">
           <div style="width:0;height:0;border-left:15px solid transparent;
                       border-right:15px solid transparent;
                       border-bottom:30px solid red;
                       transform-origin:center;"></div>
           <div style="position:absolute; top:30px; left:14px;
                       width:2px; height:40px; background:rgba(255,0,0,0.4); border-radius:1px;"></div>
           </div>`,
    iconSize: [30, 50],
    iconAnchor: [15, 25]
});

// دالة تحديث اسم المكان باستخدام Nominatim
async function updatePlaceName(lat, lon){
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`);
        const data = await response.json();
        locationNameDiv.textContent = data.display_name || "مكان غير معروف";
    } catch(e) {
        locationNameDiv.textContent = "خطأ في تحديد المكان";
    }
}

// فلترة وتحسين دقة المواقع
let lastPosition = null;
function isValidPosition(newPos){
    if(!lastPosition) return true;
    const dist = map.distance([lastPosition.latitude, lastPosition.longitude], [newPos.latitude, newPos.longitude]);
    return newPos.accuracy < 50 && dist > 0.5; // تجاهل القراءات الضعيفة جداً
}

// متابعة الموقع بدقة عالية
if(navigator.geolocation){
    navigator.geolocation.watchPosition(
        (pos)=>{
            const coords = pos.coords;

            if(!isValidPosition(coords)) return;

            lastPosition = coords;

            // تحديث اسم المكان
            updatePlaceName(coords.latitude, coords.longitude);

            // إنشاء أو تحديث الـMarker
            if(!userMarker){
                userMarker = L.marker([coords.latitude, coords.longitude], {icon: arrowIcon, rotationAngle: coords.heading || 0}).addTo(map);
                map.setView([coords.latitude, coords.longitude], 18);
            } else {
                userMarker.setLatLng([coords.latitude, coords.longitude]);
                userMarker.getElement().style.transform = `rotate(${coords.heading || 0}deg)`;
            }

            // تحديث الخريطة تلقائياً إذا لم يقم المستخدم بتحريكها
            if(!map.dragging._draggable._moving){
                map.setView([coords.latitude, coords.longitude]);
            }

        },
        (err)=>{
            console.error(err);
            locationNameDiv.textContent = "تعذر الحصول على الموقع.";
        },
        {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 15000
        }
    );
} else {
    alert("متصفحك لا يدعم خدمة تحديد الموقع.");
}
</script>

</body>
</html>
