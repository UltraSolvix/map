<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة الموقع السلسة والمفصلة</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { margin:0; padding:0; height:100%; font-family:sans-serif; background:#f0f0f0; }
#mapContainer { height:100%; width:100%; }

.place-name {
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.85);
    padding:10px 20px;
    border-radius:15px;
    font-size:16px;
    font-weight:bold;
    color:#2c3e50;
    z-index:1000;
    pointer-events:none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    backdrop-filter: blur(5px);
    transition: all 0.3s;
}
</style>
</head>
<body>

<div id="mapContainer"></div>
<div class="place-name" id="placeName">جاري تحديد موقعك...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('mapContainer', { 
    zoomControl:true, 
    gestureHandling:true, // يدعم التكبير والتصغير والدوران باللمس
}).setView([30.0444,31.2357],17);

let marker = null;
let userCoords = null;
let targetCoords = null;

// إضافة طبقات مفصلة للخريطة (OpenStreetMap + HikeBike + Carto)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 22
}).addTo(map);

// طبقة إضافية للمزيد من التفاصيل
L.tileLayer('https://tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png', {
    maxZoom: 20,
    opacity:0.4
}).addTo(map);

// دالة التحريك السلس للعلامة
function animateMarker(){
    if(!marker || !targetCoords) return;

    const current = marker.getLatLng();
    const latDiff = targetCoords[0] - current.lat;
    const lngDiff = targetCoords[1] - current.lng;
    const step = 0.2;

    const newLat = current.lat + latDiff * step;
    const newLng = current.lng + lngDiff * step;

    marker.setLatLng([newLat, newLng]);

    // الخريطة تتحرك فقط إذا لم يقم المستخدم بتحريكها
    if(!userInteracted){
        map.panTo([newLat, newLng], {animate:false});
    }

    requestAnimationFrame(animateMarker);
}

// اكتشاف تفاعل المستخدم لمنع إعادة مركز الخريطة
let userInteracted = false;
map.on('movestart', ()=>{ userInteracted = true; });
map.on('zoomstart', ()=>{ userInteracted = true; });
map.on('rotate', ()=>{ userInteracted = true; });

// تتبع الموقع
if(navigator.geolocation){
    navigator.geolocation.watchPosition(async (pos)=>{
        targetCoords = [pos.coords.latitude, pos.coords.longitude];
        userCoords = [...targetCoords];

        if(!marker){
            marker = L.marker(userCoords).addTo(map);
            animateMarker(); // بدء التحريك السلس
        }

        // تحديث اسم المكان فقط
        try{
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${targetCoords[0]}&lon=${targetCoords[1]}&zoom=18&accept-language=ar`);
            const data = await res.json();
            document.getElementById('placeName').textContent = data.display_name || 'غير متاح';
        }catch{
            document.getElementById('placeName').textContent = 'غير متاح';
        }

    }, (err)=>{
        console.error('خطأ في تحديد الموقع:', err);
    }, { enableHighAccuracy:true, maximumAge:0, timeout:5000 });
}
</script>

</body>
</html>
