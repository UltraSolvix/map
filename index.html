<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø®Ø±ÙŠØ·Ø© Ù…ØµØ± Ø§Ù„Ø°ÙƒÙŠØ© - Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
  html, body { 
    height: 100%; 
    margin: 0; 
    padding: 0; 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f6f9;
    direction: rtl;
  }

  #controls {
    background: linear-gradient(135deg, #007bff, #0056b3);
    padding: 15px;
    color: white;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    position: relative;
    z-index: 1000;
  }

  h2 {
    margin-bottom: 20px;
    font-size: 1.4rem;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }

  .input-group {
    position: relative;
    display: inline-block;
    width: 85%;
    max-width: 350px;
    margin: 8px;
  }

  input {
    padding: 12px 15px;
    width: 100%;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  input:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.3);
    transform: translateY(-2px);
  }

  input::placeholder { 
    color: #aaa; 
    font-size: 14px;
  }

  button {
    padding: 12px 30px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    margin-top: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  button:hover { 
    background: linear-gradient(135deg, #218838, #1e9e8a);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.25);
  }

  button:active {
    transform: translateY(0);
  }

  #map {
    width: 100%;
    height: 75vh;
  }

  #status {
    text-align: center;
    padding: 12px;
    font-weight: bold;
    background: white;
    color: #333;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    min-height: 20px;
    transition: all 0.3s ease;
  }

  .suggestions {
    position: absolute;
    background: #fff;
    border: 1px solid #ddd;
    max-height: 160px;
    overflow-y: auto;
    z-index: 2000;
    width: 100%;
    border-radius: 0 0 8px 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
  }

  .suggestions div {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.2s ease;
  }

  .suggestions div:hover {
    background: #e3f2fd;
  }

  .suggestions div:last-child {
    border-bottom: none;
  }

  .hint {
    font-size: 12px;
    color: #e0e0e0;
    margin-top: 8px;
    font-style: italic;
  }

  /* Ø´Ø±ÙŠØ· Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø´ÙØ§Ù */
  #location {
    position: absolute;
    top: 12px;
    right: 12px;
    background: rgba(255,255,255,0.85);
    padding: 8px 12px;
    border-radius: 8px;
    font-family: "Cairo", sans-serif;
    font-size: 16px;
    color: #000;
    z-index: 9999;
    backdrop-filter: blur(4px);
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹ (Ø¯Ø§Ø¦Ø±Ø© ØµØºÙŠØ±Ø© ÙˆØ¬Ù…ÙŠÙ„Ø©) */
  #recenter {
    position: absolute;
    bottom: 18px;
    right: 12px;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.18);
    cursor: pointer;
    z-index: 9999;
    font-size: 18px;
  }
  #recenter:active { transform: scale(0.98); }

  /* Ù…Ø¤Ø´Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø§ØªØµØ§Ù„/Ø§Ù„Ø­Ø§Ù„Ø© */
  #gps-status {
    position: absolute;
    bottom: 12px;
    left: 12px;
    background: rgba(255,255,255,0.75);
    padding: 6px 10px;
    border-radius: 8px;
    font-family: "Cairo", sans-serif;
    font-size: 13px;
    z-index: 9999;
  }

  /* Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ */
  #use-my-location {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    margin-left: 10px;
  }

  #use-my-location:hover {
    background: linear-gradient(135deg, #f57c00, #e65100);
  }

  /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
  @media (max-width: 768px) {
    .input-group {
      width: 90%;
    }
    input {
      font-size: 16px;
    }
    h2 {
      font-size: 1.2rem;
    }
    #location {
      max-width: 70%;
      font-size: 14px;
    }
  }
</style>
</head>
<body>

<div id="controls">
  <h2>ğŸš— Ø®Ø±ÙŠØ·ØªÙƒ Ø§Ù„Ø°ÙƒÙŠØ© ÙÙŠ Ù…ØµØ± - Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ù…Ø³Ø§Ø±Ø§Øª</h2>
  <div class="input-group">
    <input id="start" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: Ù†ÙƒÙ„Ø§ØŒ Ø§Ù„Ù…Ù†ÙŠØ§)">
    <div id="start-suggestions" class="suggestions"></div>
  </div>
  <div class="input-group">
    <input id="end" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: Ø£Ù… Ø¯ÙŠÙ†Ø§Ø±ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©)">
    <div id="end-suggestions" class="suggestions"></div>
  </div>
  <button onclick="getRoute()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±</button>
  <button id="use-my-location" onclick="useMyLocation()">Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
  <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†</div>
</div>

<div id="status">ğŸ” Ø§Ø¨Ø¯Ø£ Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø£Ø¹Ù„Ø§Ù‡</div>
<div id="map"></div>

<div id="location">Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: <span id="address">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span></div>
<div id="recenter" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆÙ‚Ø¹">â—</div>
<div id="gps-status">ÙˆØ¶Ø¹: Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€” Ø¯Ù‚Ø© Ù…Ø³ØªÙ‡Ø¯ÙØ© â‰¤ 3 Ù…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ù…ØµØ±
const map = L.map('map').setView([26.8206, 30.8025], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let routingControl = null;
let currentRoute = null;
const statusDiv = document.getElementById('status');
const gpsStatusDiv = document.getElementById('gps-status');

// Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
const removeRoutingPanels = () => {
    const panels = document.querySelectorAll('.leaflet-routing-container');
    panels.forEach(p => {
        p.style.display = 'none';
        p.remove();
    });
};

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„Ù„Ø¨Ø­Ø«
async function fetchSuggestions(query, suggestionBox) {
    if (query.length < 2) {
        suggestionBox.style.display = 'none';
        suggestionBox.innerHTML = '';
        return;
    }

    try {
        // Ø¥Ø¶Ø§ÙØ© "Ù…ØµØ±" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø¨Ø­Ø«
        const searchQuery = query.includes('Ù…ØµØ±') ? query : `${query}, Ù…ØµØ±`;
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=eg&limit=7&accept-language=ar`;
        
        const response = await fetch(url, { 
            headers: { 'User-Agent': 'EgyptSmartMap/1.0' } 
        });
        const data = await response.json();

        suggestionBox.innerHTML = '';
        
        if (data.length === 0) {
            suggestionBox.style.display = 'none';
            return;
        }

        data.forEach(place => {
            const div = document.createElement('div');
            // ØªÙ‚ØµÙŠØ± Ø§Ù„Ù†Øµ Ù„Ø¹Ø±Ø¶ Ø£ÙØ¶Ù„
            const displayName = place.display_name.split(',').slice(0, 3).join(',');
            div.textContent = displayName;
            div.title = place.display_name; // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
            div.onclick = () => {
                const input = suggestionBox.previousElementSibling;
                input.value = place.display_name;
                suggestionBox.style.display = 'none';
                suggestionBox.innerHTML = '';
            };
            suggestionBox.appendChild(div);
        });
        
        suggestionBox.style.display = 'block';
    } catch (error) {
        console.error('Error fetching suggestions:', error);
        suggestionBox.style.display = 'none';
    }
}

// Ø±Ø¨Ø· Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
function setupInputWithSuggestions(inputId, suggestionsId) {
    const input = document.getElementById(inputId);
    const suggestions = document.getElementById(suggestionsId);
    let timeoutId;

    input.addEventListener('input', (e) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            fetchSuggestions(e.target.value, suggestions);
        }, 300); // ØªØ£Ø®ÙŠØ± 300ms Ù„ØªÙ‚Ù„ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª API
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
    document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Øµ
    input.addEventListener('focus', () => {
        if (input.value.length >= 2) {
            fetchSuggestions(input.value, suggestions);
        }
    });
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
setupInputWithSuggestions('start', 'start-suggestions');
setupInputWithSuggestions('end', 'end-suggestions');

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
async function geocode(place) {
    if (!place.trim()) throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù†');
    
    // Ø¥Ø¶Ø§ÙØ© "Ù…ØµØ±" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    const searchPlace = place.includes('Ù…ØµØ±') ? place : `${place}, Ù…ØµØ±`;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchPlace)}&countrycodes=eg&limit=1&accept-language=ar`;
    
    const response = await fetch(url, { 
        headers: { 'User-Agent': 'EgyptSmartMap/1.0' } 
    });
    const data = await response.json();
    
    if (data.length === 0) {
        throw new Error(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ "${place}". Ø¬Ø±Ø¨ Ø§Ø³Ù…Ù‹Ø§ Ø£ÙƒØ«Ø± ØªØ­Ø¯ÙŠØ¯Ù‹Ø§.`);
    }
    
    return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
}

// Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ©
function useMyLocation() {
    if (lastPos) {
        document.getElementById('start').value = 'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ';
        statusDiv.textContent = 'âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ†Ù‚Ø·Ø© Ø¨Ø¯Ø§ÙŠØ©';
    } else {
        statusDiv.textContent = 'âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...';
    }
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª
async function getRoute() {
    const startVal = document.getElementById('start').value.trim();
    const endVal = document.getElementById('end').value.trim();

    if (!startVal || !endVal) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Ù‚Ø·ØªÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
    }

    try {
        statusDiv.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª...';
        
        let startCoords;
        if (startVal === 'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ' && lastPos) {
            startCoords = [lastPos.lat, lastPos.lon];
        } else {
            startCoords = await geocode(startVal);
        }
        
        const endCoords = await geocode(endVal);

        statusDiv.textContent = 'ğŸš— Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø£ÙØ¶Ù„ Ù…Ø³Ø§Ø±...';

        if (routingControl) {
            map.removeControl(routingControl);
        }

        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(startCoords[0], startCoords[1]),
                L.latLng(endCoords[0], endCoords[1])
            ],
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1/',
                profile: 'driving'
            }),
            lineOptions: {
                styles: [{ color: '#ff0000', weight: 6, opacity: 0.8 }]
            },
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            showAlternatives: false,
            createMarker: function() { return null; }
        }).addTo(map);

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³Ø§Ø±
        setTimeout(removeRoutingPanels, 100);

        routingControl.on('routesfound', e => {
            const summary = e.routes[0].summary;
            const dist = (summary.totalDistance / 1000).toFixed(1);
            const time = Math.round(summary.totalTime / 60);
            statusDiv.innerHTML = `âœ… <strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${dist} ÙƒÙ… | <strong>Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> ${time} Ø¯Ù‚ÙŠÙ‚Ø©`;
            removeRoutingPanels();
            
            // Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
            currentRoute = e.routes[0];
            
            // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±
            startRouteTracking();
        });

        routingControl.on('routingerror', e => {
            statusDiv.textContent = 'âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        });

    } catch (err) {
        console.error(err);
        statusDiv.innerHTML = `âŒ <strong>Ø®Ø·Ø£:</strong> ${err.message}`;
    }
}

// Ù…ØªØºÙŠØ±Ø§Øª ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
let marker = null;
let lastPos = null;
let nextPos = null;
let animStart = null;
let animDur = 1000;
let userHasPanned = false;
let autoCenter = true;
let routeProgress = null;
let routeTracking = false;

// Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const locLabel = document.getElementById('location');
const recenterBtn = document.getElementById('recenter');

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
const POLL_INTERVAL_MS = 1000;
const TARGET_ACCURACY_M = 3;
const REVERSE_GEOCODE_MIN_MOVE = 3;

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† Ø¨Ø§Ù„Ø£Ù…ØªØ§Ø± (Haversine)
function haversineMeters(a, b){
    const R = 6371000;
    const toRad = v => v * Math.PI/180;
    const dLat = toRad(b.lat-a.lat);
    const dLon = toRad(b.lon-a.lon);
    const lat1 = toRad(a.lat);
    const lat2 = toRad(b.lat);
    const sinDlat = Math.sin(dLat/2), sinDlon = Math.sin(dLon/2);
    const A = sinDlat*sinDlat + sinDlon*sinDlon * Math.cos(lat1)*Math.cos(lat2);
    const C = 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1-A));
    return R * C;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ù€ reverse geocoding Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Nominatim (OpenStreetMap)
async function reverseGeocodeIfNeeded(lat, lon){
    try{
        if (!reverseGeocodeIfNeeded.last || haversineMeters(reverseGeocodeIfNeeded.last, {lat,lon}) > REVERSE_GEOCODE_MIN_MOVE){
            reverseGeocodeIfNeeded.last = {lat,lon};
            locLabel.innerHTML = 'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: <span id="address">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹...</span>';
            const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=20&addressdetails=1&accept-language=ar`;
            const res = await fetch(url, { headers: { 'User-Agent': 'MyMapApp/1.0' } });
            if (!res.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†');
            const data = await res.json();
            const addr = data.address || {};
            const street = addr.road || addr.pedestrian || addr.footway || addr.cycleway || addr.highway || '';
            const building = addr.house_number ? (' ' + addr.house_number) : '';
            const area = addr.suburb || addr.neighbourhood || addr.village || '';
            const city = addr.city || addr.town || addr.county || addr.state || '';
            let name = '';
            if (street) name = street + building;
            if (!name && area) name = area;
            if (!name && city) name = city;
            if (!name) name = data.display_name || 'Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

            // Ø¶Ø¹ Ø§Ù„Ø§Ø³Ù… Ù…ÙÙ‚ØªÙØµØ±Ø§Ù‹ Ø§Ø°Ø§ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹
            if (name.length > 80) name = name.slice(0,80) + '...';
            locLabel.innerHTML = `Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: <span id="address">${name}</span>`;
        }
    }catch(e){
        console.error('reverse geocode failed', e);
        locLabel.innerHTML = 'Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: <span id="address">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>';
    }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¶Ø¹ â€” Ù†Ù‚ÙˆÙ… Ø¨ØªØ³Ù„Ø³Ù„ Ø­Ø±ÙƒÙŠ Ù†Ø§Ø¹Ù… Ø¨ÙŠÙ† lastPos Ùˆ nextPos
function animate(){
    requestAnimationFrame(animate);
    if (!lastPos || !nextPos) return;
    const now = performance.now();
    const t = Math.min(1, (now - animStart) / animDur);
    const lat = lastPos.lat + (nextPos.lat - lastPos.lat) * t;
    const lon = lastPos.lon + (nextPos.lon - lastPos.lon) * t;

    // ØªØ­Ø¯ÙŠØ« marker
    if (!marker){
        marker = L.circleMarker([lat, lon], {
            radius: 10,
            fillColor: "#0078ff",
            color: "#0056b3",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);
    } else {
        marker.setLatLng([lat, lon]);
    }

    // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù… ÙŠØ²Ù„Ù‘ Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ù„Ù… ÙŠÙ‚Ù… Ø¨Ø§Ù„ØªØ­Ø±ÙŠÙƒ) Ø£Ùˆ ÙˆØ¶Ø¹Ù†Ø§ autoCenter true
    if (autoCenter) {
        map.setView([lat, lon], map.getZoom(), { animate: true, pan: { duration: 0.9 } });
    }

    // Ø¹Ù†Ø¯Ù…Ø§ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø­Ø±ÙƒØ©ØŒ Ù†Ù‚Ù‘Ø¯Ù… lastPos
    if (t >= 1){
        lastPos = { ...nextPos, time: Date.now() };
        nextPos = null;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³Ø§Ø± Ù†Ø´Ø·ØŒ ØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
        if (routeTracking && currentRoute) {
            updateRouteProgress(lastPos.lat, lastPos.lon);
        }
    }
}
animate();

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø©ØŒ Ù†Ø¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØªØ¨Ø¹ ÙˆÙ…Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø©
recenterBtn.addEventListener('click', ()=>{
    autoCenter = true;
    userHasPanned = false;
    if (lastPos) map.setView([lastPos.lat, lastPos.lon], 17, { animate:true });
});

// ÙƒØ´Ù Ø­Ø¯Ø« ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
map.on('movestart', ()=>{ userHasPanned = true; autoCenter = false; });

// Ø¯Ø§Ù„Ø© Ù„ØªÙ„Ù‚ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª GPS ÙˆØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒÙ€ nextPos (ØªØ¹Ù…Ù„ ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©)
function handleNewGPS(lat, lon, accuracy){
    gpsStatusDiv.textContent = `Ø¯Ù‚Ø©: ${Math.round(accuracy)} Ù… â€” Ù…Ø³ØªÙ‡Ø¯ÙØ© â‰¤ ${TARGET_ACCURACY_M} Ù…`;

    const incoming = { lat: lat, lon: lon };
    if (!lastPos){
        // Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        lastPos = { ...incoming, time: Date.now() };
        nextPos = { ...incoming };
        animStart = performance.now();
        // Ù†ÙˆÙ‚Ù ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙÙ‚Ø· Ù„Ùˆ autoCenter true
        if (autoCenter) map.setView([lat, lon], 17);
        reverseGeocodeIfNeeded(lat, lon);
        return;
    }

    // Ù„Ùˆ Ø§Ù„Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ØŒ Ù„Ø§ Ù†ØºÙŠØ± reverse geocode
    const dist = haversineMeters(lastPos, incoming);

    // Ø¶Ø¨Ø· Ù…Ø¯Ø© Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠØ› Ù„ÙƒÙ† Ù†Ø¨Ù‚ÙŠÙ‡Ø§ â‰ˆ 1000ms Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ø·Ù„Ø¨
    animStart = performance.now();
    animDur = POLL_INTERVAL_MS;

    // Ù†Ø¶Ø¹ nextPos Ù„ØªØªØ­Ø±Ùƒ Ø§Ù„Ø³Ù„Ø³Ø©
    nextPos = { ...incoming };

    // Ù†Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† Ù„Ùˆ ØªØ­Ø±ÙƒÙ†Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ø­Ø¯
    if (dist > REVERSE_GEOCODE_MIN_MOVE) reverseGeocodeIfNeeded(lat, lon);
}

// Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±
function startRouteTracking() {
    if (!currentRoute) return;
    
    routeTracking = true;
    routeProgress = {
        completedSegments: [],
        currentSegmentIndex: 0,
        totalDistance: currentRoute.summary.totalDistance,
        completedDistance: 0
    };
    
    statusDiv.innerHTML += ' | <strong>Ø¬Ø§Ø±ÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±...</strong>';
}

// ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø±
function updateRouteProgress(lat, lon) {
    if (!currentRoute || !routeTracking) return;
    
    const currentPoint = L.latLng(lat, lon);
    let closestSegmentIndex = -1;
    let minDistance = Infinity;
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù‚Ø±Ø¨ Ù…Ù‚Ø·Ø¹ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø±
    for (let i = 0; i < currentRoute.coordinates.length - 1; i++) {
        const segmentStart = L.latLng(currentRoute.coordinates[i]);
        const segmentEnd = L.latLng(currentRoute.coordinates[i + 1]);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ù‚Ø·Ø¹
        const distance = pointToSegmentDistance(currentPoint, segmentStart, segmentEnd);
        
        if (distance < minDistance) {
            minDistance = distance;
            closestSegmentIndex = i;
        }
    }
    
    // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ù…Ù‚Ø·Ø¹ Ù‚Ø±ÙŠØ¨ (Ø¶Ù…Ù† 50 Ù…ØªØ±)
    if (closestSegmentIndex !== -1 && minDistance < 50) {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ø°Ø§ ØªÙ‚Ø¯Ù…Ù†Ø§
        if (closestSegmentIndex > routeProgress.currentSegmentIndex) {
            routeProgress.currentSegmentIndex = closestSegmentIndex;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
            let completed = 0;
            for (let i = 0; i < closestSegmentIndex; i++) {
                completed += haversineMeters(
                    currentRoute.coordinates[i],
                    currentRoute.coordinates[i + 1]
                );
            }
            routeProgress.completedDistance = completed;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø±
            const progressPercent = (routeProgress.completedDistance / routeProgress.totalDistance * 100).toFixed(1);
            statusDiv.innerHTML = `âœ… <strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${(routeProgress.totalDistance/1000).toFixed(1)} ÙƒÙ… | <strong>Ø§Ù„ØªÙ‚Ø¯Ù…:</strong> ${progressPercent}%`;
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±
            updateRouteColors();
        }
    }
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù…Ù† Ù†Ù‚Ø·Ø© Ø¥Ù„Ù‰ Ù…Ù‚Ø·Ø¹ Ø®Ø·ÙŠ
function pointToSegmentDistance(point, segmentStart, segmentEnd) {
    const A = point.lat - segmentStart.lat;
    const B = point.lng - segmentStart.lng;
    const C = segmentEnd.lat - segmentStart.lat;
    const D = segmentEnd.lng - segmentStart.lng;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;
    
    if (lenSq !== 0) {
        param = dot / lenSq;
    }

    let xx, yy;

    if (param < 0) {
        xx = segmentStart.lat;
        yy = segmentStart.lng;
    } else if (param > 1) {
        xx = segmentEnd.lat;
        yy = segmentEnd.lng;
    } else {
        xx = segmentStart.lat + param * C;
        yy = segmentStart.lng + param * D;
    }

    const dx = point.lat - xx;
    const dy = point.lng - yy;
    
    return Math.sqrt(dx * dx + dy * dy) * 111320; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø£Ù…ØªØ§Ø±
}

// ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø¯Ù…
function updateRouteColors() {
    if (!routingControl || !routeProgress) return;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø³Ø§Ø±
    const routeElement = document.querySelector('.leaflet-routing-line');
    if (!routeElement) return;
    
    // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ø© Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ø§Ù‹ Ù„ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø±
    // Ù‡Ø°Ù‡ Ù…Ø¬Ø±Ø¯ ÙÙƒØ±Ø© Ù…Ø¨Ø³Ø·Ø©
    const progressPercent = routeProgress.completedDistance / routeProgress.totalDistance;
    
    // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…ÙƒØªÙ…Ù„
    // ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ø³Ù†Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ ÙˆØªÙ„ÙˆÙŠÙ† ÙƒÙ„ Ø¬Ø²Ø¡ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
}

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… watchPosition (Ø£Ø³Ø±Ø¹ ÙˆØ£Ø¯Ù‚ Ø¹Ù†Ø¯ ØªÙˆÙØ±Ù‡)ØŒ Ù„ÙƒÙ† Ø³Ù†Ø³ØªØ®Ø¯Ù… poll Ø£ÙŠØ¶Ø§Ù‹ ÙƒÙ„ 1 Ø«Ø§Ù†ÙŠØ©
let watchId = null;
function startTracking(){
    if (!('geolocation' in navigator)){
        gpsStatusDiv.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
        return;
    }

    // Ø£ÙØ¶Ù„ Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ø·Ù„Ø¨ Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© â€” Ù„ÙƒÙ† Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ¥Ø´Ø§Ø±Ø© GPS
    try{
        watchId = navigator.geolocation.watchPosition(pos => {
            const { latitude, longitude, accuracy } = pos.coords;
            // Ù†Ø¹Ø·ÙŠ Ø£ÙˆÙ„ÙˆÙŠØ© Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª watchPosition
            handleNewGPS(latitude, longitude, accuracy);
        }, err => {
            console.error('watchPosition error', err);
            gpsStatusDiv.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­)';
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
    }catch(e){
        console.error(e);
    }

    // poll Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒÙ„ 1 Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø³Ù„ watchPosition Ø¨Ø³Ø±Ø¹Ø© ÙƒØ§ÙÙŠØ©
    setInterval(()=>{
        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude, accuracy } = pos.coords;
            handleNewGPS(latitude, longitude, accuracy);
        }, err => {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø¤Ù‚ØªØ©
        }, { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 });
    }, POLL_INTERVAL_MS);
}

// Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØªØ¨Ø¹ ÙÙˆØ±Ø§Ù‹
startTracking();

// Ø¯Ø¹Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
document.addEventListener('keypress', e => { 
    if (e.key === 'Enter') getRoute(); 
});

// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ±
map.whenReady(() => {
    statusDiv.textContent = 'ğŸŒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†!';
});

// Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
document.getElementById('start').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') e.preventDefault();
});
document.getElementById('end').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') e.preventDefault();
});
</script>

</body>
</html>
