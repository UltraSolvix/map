<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة الرحلة الاحترافية - مصر</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html, body { margin:0; padding:0; height:100%; font-family:sans-serif; background:#f0f0f0; }
#mapContainer { height:100%; width:100%; }
.place-name {
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.85);
    padding:10px 20px;
    border-radius:15px;
    font-size:16px;
    font-weight:bold;
    color:#2c3e50;
    z-index:1000;
    pointer-events:none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    backdrop-filter: blur(5px);
}
#startJourneyBtn {
    position:fixed;
    bottom:15px;
    left:50%;
    transform:translateX(-50%);
    padding:10px 20px;
    font-size:16px;
    font-weight:bold;
    background:#2c3e50;
    color:white;
    border:none;
    border-radius:10px;
    cursor:pointer;
    z-index:1000;
}
#startJourneyBtn:hover { background:#34495e; }
.popup {
    display:none;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:white;
    padding:20px;
    border-radius:15px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    z-index:2000;
    width:90%;
    max-width:450px;
}
.popup input, .popup textarea {
    width:100%;
    padding:8px;
    margin:10px 0;
    border:1px solid #ccc;
    border-radius:5px;
}
.popup button {
    padding:10px 20px;
    margin:5px;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
.popup button.submit { background:#2ecc71; color:white; }
.popup button.cancel { background:#ccc; }
.autocomplete-suggestions {
    position:absolute;
    background:white;
    border:1px solid #ccc;
    max-height:150px;
    overflow-y:auto;
    width:calc(100% - 16px);
    z-index:3000;
    border-radius:5px;
}
.autocomplete-suggestions div {
    padding:8px;
    cursor:pointer;
}
.autocomplete-suggestions div:hover { background:#f0f0f0; }
.loading {
    display:none;
    position:absolute;
    top:10px;
    right:10px;
    z-index:1000;
    font-size:14px;
    color:#2c3e50;
}
</style>
</head>
<body>

<div id="mapContainer"></div>
<div class="place-name" id="placeName">جاري تحديد موقعك...</div>
<button id="startJourneyBtn">بدء الرحلة</button>

<div class="popup" id="journeyPopup">
    <h3>تخطيط الرحلة</h3>
    <label>نقطة البداية:</label>
    <input type="text" id="startPoint" placeholder="اختر موقعك أو أدخل مكان داخل مصر">
    <div class="autocomplete-suggestions" id="startSuggestions"></div>

    <label>نقطة النهاية:</label>
    <input type="text" id="endPoint" placeholder="أدخل نقطة النهاية داخل مصر">
    <div class="autocomplete-suggestions" id="endSuggestions"></div>

    <label>تفاصيل إضافية لنقطة النهاية:</label>
    <textarea id="endDetails" placeholder="مثال: قرية، شارع، حي..."></textarea>

    <button class="submit" onclick="submitJourney()">تم</button>
    <button class="cancel" onclick="closePopup()">إلغاء</button>
</div>

<div class="loading" id="loading">جاري التحميل...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('mapContainer').setView([30.0444,31.2357], 6);
let markers = [];
let routeLayer = null;

// OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap', maxZoom:22 }).addTo(map);

// فتح/إغلاق النافذة المنبثقة
document.getElementById('startJourneyBtn').addEventListener('click', () => { document.getElementById('journeyPopup').style.display='block'; });
function closePopup(){
    document.getElementById('journeyPopup').style.display='none';
    document.getElementById('startSuggestions').innerHTML='';
    document.getElementById('endSuggestions').innerHTML='';
}

// التتبع التلقائي لموقع المستخدم
if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        document.getElementById('placeName').textContent = 'موقعك الحالي';
        document.getElementById('startPoint').value = 'موقعي الحالي';
        document.getElementById('startPoint').dataset.lat = lat;
        document.getElementById('startPoint').dataset.lon = lon;
        if(markers.length>0) markers.forEach(m=>map.removeLayer(m));
        const m = L.marker([lat,lon]).addTo(map).bindPopup('بداية الرحلة').openPopup();
        markers.push(m);
        map.setView([lat,lon],15);
    }, err=>{
        console.warn('GPS غير متاح، استخدم نقطة بداية يدوية');
    }, {enableHighAccuracy:true, timeout:5000});
}

// وظيفة البحث الذكي (Autocomplete)
async function autocomplete(input, suggestionsDiv){
    const query = input.value;
    if(query.length<3){ suggestionsDiv.innerHTML=''; return; }
    try{
        document.getElementById('loading').style.display='block';
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, مصر&accept-language=ar&countrycodes=eg&viewbox=24.7,22,31.7,31&bounded=1&addressdetails=1&limit=10`;
        const res = await fetch(url);
        const data = await res.json();
        suggestionsDiv.innerHTML='';
        data.sort((a,b)=>b.importance-b.importance);
        data.forEach(place=>{
            const div = document.createElement('div');
            div.textContent = place.display_name;
            div.onclick=()=>{
                input.value = place.display_name;
                input.dataset.lat = place.lat;
                input.dataset.lon = place.lon;
                suggestionsDiv.innerHTML='';
            };
            suggestionsDiv.appendChild(div);
        });
        document.getElementById('loading').style.display='none';
    }catch(err){
        console.error(err);
        document.getElementById('loading').style.display='none';
    }
}
document.getElementById('startPoint').addEventListener('input', ()=>autocomplete(document.getElementById('startPoint'), document.getElementById('startSuggestions')));
document.getElementById('endPoint').addEventListener('input', ()=>autocomplete(document.getElementById('endPoint'), document.getElementById('endSuggestions')));

// إرسال الرحلة وحساب المسار
async function submitJourney(){
    const startInput = document.getElementById('startPoint');
    const endInput = document.getElementById('endPoint');
    const endDetails = document.getElementById('endDetails').value.trim();

    if(!startInput.dataset.lat || !endInput.dataset.lat){
        alert('اختر نقطة البداية والنهاية من القائمة الذكية (مصر)');
        return;
    }

    const startCoords = [parseFloat(startInput.dataset.lat), parseFloat(startInput.dataset.lon)];
    const endCoords = [parseFloat(endInput.dataset.lat), parseFloat(endInput.dataset.lon)];

    try{
        document.getElementById('loading').style.display='block';

        // إضافة معلومات إضافية لنهاية الرحلة (تفاصيل دقيقة)
        if(endDetails) endInput.value += ' - ' + endDetails;

        // إزالة علامات قديمة
        markers.forEach(m=>map.removeLayer(m));
        markers = [];

        // إضافة علامات البداية والنهاية
        markers.push(L.marker(startCoords).addTo(map).bindPopup('نقطة البداية').openPopup());
        markers.push(L.marker(endCoords).addTo(map).bindPopup('نقطة النهاية: '+endInput.value).openPopup());

        // حساب المسار عبر OpenRouteService
        const ORS_API_KEY = 'YOUR_API_KEY_HERE'; // ضع مفتاحك هنا
        const routeRes = await fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson',{
            method:'POST',
            headers:{ 'Authorization':ORS_API_KEY,'Content-Type':'application/json' },
            body:JSON.stringify({ coordinates:[[startCoords[1],startCoords[0]], [endCoords[1],endCoords[0]]], instructions:true })
        });
        const routeData = await routeRes.json();

        if(routeLayer) map.removeLayer(routeLayer);
        routeLayer = L.geoJSON(routeData, { style:{ color:'#e74c3c', weight:5 } }).addTo(map);
        map.fitBounds(routeLayer.getBounds());

        closePopup();
        document.getElementById('loading').style.display='none';
    }catch(err){
        console.error(err);
        alert('حدث خطأ أثناء حساب المسار');
        document.getElementById('loading').style.display='none';
    }
}
</script>

</body>
</html>
