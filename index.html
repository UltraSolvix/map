<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø±Ø¹</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #map { height: 100%; }
  #location {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255,255,255,0.9);
    padding: 8px 14px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    font-family: "Cairo", sans-serif;
    font-size: 16px;
    direction: rtl;
    z-index: 9999;
  }
</style>
</head>
<body>

<div id="location">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="address">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span></div>
<div id="map"></div>

<script>
  const map = L.map('map').setView([30.0444, 31.2357], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; Ø®Ø±ÙŠØ·Ø© Ù…Ù† OpenStreetMap'
  }).addTo(map);

  let marker;

  async function getAccurateLocationName(lat, lon) {
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=20&addressdetails=1&accept-language=ar`,
        { headers: { 'User-Agent': 'MyMapApp/1.0 (contact@example.com)' } }
      );
      const data = await res.json();
      const addr = data.address || {};

      const street = addr.road || addr.pedestrian || addr.highway || "";
      const area = addr.neighbourhood || addr.suburb || addr.village || "";
      const city = addr.town || addr.city || addr.county || "";
      let name = street && city ? `${street}ØŒ ${city}` :
                 street && area ? `${street}ØŒ ${area}` :
                 area && city ? `${area}ØŒ ${city}` :
                 data.display_name || "Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

      if (name.length > 60) name = name.split("ØŒ").slice(0, 3).join("ØŒ ");
      return name;
    } catch (err) {
      console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:", err);
      return "Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...";
    }
  }

  function updatePosition(lat, lon) {
    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lon]).addTo(map);
  }

  // âœ… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø©
  navigator.geolocation.watchPosition(
    async pos => {
      const { latitude, longitude } = pos.coords;
      updatePosition(latitude, longitude);

      // ÙÙ‚Ø· Ø£ÙˆÙ„ Ù…Ø±Ø© Ù†Ø±ÙƒØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (!map._userLocated) {
        map.setView([latitude, longitude], 16);
        map._userLocated = true;
      }

      const name = await getAccurateLocationName(latitude, longitude);
      document.getElementById("address").textContent = name;
    },
    err => {
      console.error(err);
      document.getElementById("address").textContent = "ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
    },
    { enableHighAccuracy: true, maximumAge: 0 }
  );
</script>

</body>
</html>
