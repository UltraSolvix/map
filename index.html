<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تحديد الموقع بدقة عالية</title>
<style>
  body {
    margin:0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:#333;
  }
  .container{
    max-width:900px; margin:0 auto; padding:20px;
  }
  h1{color:white;text-align:center;}
  .btn{
    background:#3498db;color:white;padding:12px 25px;border:none;border-radius:50px;cursor:pointer;margin:10px;font-size:16px;
  }
  .btn:hover{background:#2980b9;}
  .info, .error{
    background:#fff;padding:15px;border-radius:10px;margin:15px 0;
  }
  .info{display:none;}
  .error{display:none;color:red;}
  .map-container{
    width:100%; height:60vh; border-radius:10px; overflow:hidden; margin-top:15px; display:none;
    box-shadow:0 4px 10px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>
<div class="container">
<h1>تحديد الموقع بدقة عالية</h1>
<div class="btn" id="startBtn">ابدأ تحديد موقعي</div>
<div class="info" id="info">
  <p><strong>الموقع الحالي:</strong> <span id="placename">يتم تحديده...</span></p>
  <p><strong>الدقة:</strong> <span id="accuracy">0</span> متر</p>
</div>
<div class="error" id="error"></div>
<div class="map-container" id="mapContainer"></div>
</div>

<script>
const startBtn = document.getElementById('startBtn');
const infoDiv = document.getElementById('info');
const placenameElem = document.getElementById('placename');
const accuracyElem = document.getElementById('accuracy');
const errorDiv = document.getElementById('error');
const mapContainer = document.getElementById('mapContainer');

let watchId = null;
let bestPos = null;
let bestAcc = Infinity;

async function reverseGeocode(lat, lon){
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18`);
    const data = await res.json();
    return data.display_name || 'غير محدد';
  }catch(e){
    return 'غير محدد';
  }
}

function showMap(lat, lon){
  mapContainer.style.display='block';
  mapContainer.innerHTML = `
    <iframe 
      width="100%" 
      height="100%" 
      frameborder="0" 
      scrolling="no" 
      marginheight="0" 
      marginwidth="0" 
      src="https://maps.google.com/maps?q=${lat},${lon}&z=18&output=embed"
      style="border:0;">
    </iframe>
  `;
}

function onPosition(position){
  const {latitude, longitude, accuracy} = position.coords;

  if(accuracy < bestAcc){
    bestAcc = accuracy;
    bestPos = position;
  }

  accuracyElem.textContent = accuracy.toFixed(1);

  // إذا حصلنا على دقة أقل من 15 متر، نعتبرها ممتازة ونوقف watch
  if(accuracy <= 15){
    navigator.geolocation.clearWatch(watchId);
    bestPos = position;
    updateDisplay(position);
  }
}

async function updateDisplay(position){
  const {latitude, longitude, accuracy} = position.coords;
  const name = await reverseGeocode(latitude, longitude);

  placenameElem.textContent = name;
  accuracyElem.textContent = accuracy.toFixed(1);
  infoDiv.style.display='block';
  showMap(latitude, longitude);
}

function handleError(error){
  let msg = '';
  switch(error.code){
    case error.PERMISSION_DENIED:
      msg = 'تم رفض الوصول للموقع';
      break;
    case error.POSITION_UNAVAILABLE:
      msg = 'الموقع غير متاح';
      break;
    case error.TIMEOUT:
      msg = 'انتهت مهلة الحصول على الموقع';
      break;
    default:
      msg = 'حدث خطأ غير معروف';
  }
  errorDiv.textContent = msg;
  errorDiv.style.display='block';
}

startBtn.addEventListener('click', ()=>{
  if(!navigator.geolocation){
    handleError({code:0});
    return;
  }
  errorDiv.style.display='none';
  infoDiv.style.display='none';
  mapContainer.style.display='none';
  bestPos = null;
  bestAcc = Infinity;

  // نجمع بيانات دقيقة من GPS
  watchId = navigator.geolocation.watchPosition(onPosition, handleError, {
    enableHighAccuracy:true,
    maximumAge:0,
    timeout:20000
  });

  // بعد 10 ثواني إذا لم نحصل على دقة جيدة نأخذ أفضل قراءة
  setTimeout(()=>{
    if(bestPos){
      navigator.geolocation.clearWatch(watchId);
      updateDisplay(bestPos);
    }else{
      errorDiv.textContent='لم نتمكن من تحديد الموقع بدقة';
      errorDiv.style.display='block';
    }
  },10000);
});
</script>
</body>
</html>
