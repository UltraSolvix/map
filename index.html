<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>خريطة الموقع المتقدمة - مصر</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
html, body { margin:0; padding:0; height:100%; font-family: 'Cairo', sans-serif; background:#f0f0f0; }
#mapContainer { height:calc(100% - 60px); width:100%; touch-action: none; }
.place-name {
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.95);
    padding:12px 24px;
    border-radius:20px;
    font-size:18px;
    font-weight:700;
    color:#1a202c;
    z-index:1000;
    pointer-events:none;
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    backdrop-filter: blur(8px);
    transition: all 0.3s ease;
}
#startJourneyBtn {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    font-size: 18px;
    font-weight: 700;
    background: #1a202c;
    color: white;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    z-index: 1000;
    transition: background 0.3s;
}
#startJourneyBtn:hover {
    background: #2d3748;
}
.popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    z-index: 2000;
    width: 90%;
    max-width: 450px;
}
.popup input, .popup select {
    width: 100%;
    padding: 10px;
    margin: 12px 0;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
}
.popup button {
    padding: 10px 20px;
    margin: 8px 4px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}
.popup button.submit { background: #1a202c; color: white; }
.popup button.cancel { background: #e2e8f0; color: #1a202c; }
.autocomplete-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #e2e8f0;
    max-height: 200px;
    overflow-y: auto;
    width: calc(100% - 20px);
    z-index: 3000;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.autocomplete-suggestions div {
    padding: 10px;
    cursor: pointer;
    font-size: 14px;
}
.autocomplete-suggestions div:hover {
    background: #f7fafc;
}
.loading {
    display: none;
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    font-size: 16px;
    color: #1a202c;
    background: rgba(255,255,255,0.9);
    padding: 8px 16px;
    border-radius: 8px;
}
#routeDetails {
    display: none;
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    z-index: 1000;
    max-width: 300px;
    max-height: 60vh;
    overflow-y: auto;
}
</style>
</head>
<body>

<div id="mapContainer"></div>
<div class="place-name" id="placeName">جاري تحديد موقعك...</div>
<button id="startJourneyBtn" class="focus:outline-none">بدء رحلة</button>
<div class="popup" id="journeyPopup">
    <h3 class="text-xl font-bold mb-4">تخطيط الرحلة</h3>
    <label class="block text-sm font-medium text-gray-700">نقطة البداية:</label>
    <select id="startType" class="mb-2">
        <option value="current">موقعي الحالي</option>
        <option value="custom">مكان مخصص</option>
    </select>
    <input type="text" id="startPoint" placeholder="أدخل نقطة البداية (مصر)" class="hidden">
    <div class="autocomplete-suggestions" id="startSuggestions"></div>
    <label class="block text-sm font-medium text-gray-700 mt-4">نقطة النهاية:</label>
    <input type="text" id="endPoint" placeholder="أدخل نقطة النهاية (مصر)">
    <div class="autocomplete-suggestions" id="endSuggestions"></div>
    <label class="block text-sm font-medium text-gray-700 mt-4">تفاصيل نقطة النهاية (اختياري):</label>
    <input type="text" id="endDetails" placeholder="مثال: الشارع، الحي، القرية">
    <button class="submit" onclick="submitJourney()">تم</button>
    <button class="cancel" onclick="closePopup()">إلغاء</button>
</div>
<div class="loading" id="loading">جاري التحميل...</div>
<div id="routeDetails"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('mapContainer', { 
    zoomControl: true,
    gestureHandling: true,
}).setView([30.0444, 31.2357], 18); // Zoom 18 لدقة أعلى

let marker = null;
let userCoords = null;
let targetCoords = null;
let routeLayer = null;

// إضافة طبقات خريطة OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 22,
    tileSize: 512,
    zoomOffset: -1
}).addTo(map);

// طبقة HikeBike لتفاصيل إضافية
L.tileLayer('https://tiles.wmflabs.org/hikebike/{z}/{x}/{y}.png', {
    maxZoom: 20,
    opacity: 0.4
}).addTo(map);

// اكتشاف التفاعل للمستخدم
let userInteracted = false;
map.on('movestart', () => { userInteracted = true; });
map.on('zoomstart', () => { userInteracted = true; });
map.on('touchstart', () => { userInteracted = true; });

// تحريك العلامة بسلاسة
function animateMarker() {
    if (!marker || !targetCoords) return;

    const current = marker.getLatLng();
    const latDiff = targetCoords[0] - current.lat;
    const lngDiff = targetCoords[1] - current.lng;
    const step = 0.25;

    const newLat = current.lat + latDiff * step;
    const newLng = current.lng + lngDiff * step;

    marker.setLatLng([newLat, newLng]);

    if (!userInteracted) {
        map.panTo([newLat, newLng], { animate: false });
    }

    requestAnimationFrame(animateMarker);
}

// تتبع الموقع بدقة عالية
if (navigator.geolocation) {
    navigator.geolocation.watchPosition(async (pos) => {
        targetCoords = [pos.coords.latitude, pos.coords.longitude];
        userCoords = [...targetCoords];

        if (!marker) {
            marker = L.marker(userCoords, { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41], iconAnchor: [12, 41] }) }).addTo(map);
            animateMarker();
        }

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${targetCoords[0]}&lon=${targetCoords[1]}&zoom=18&addressdetails=1&extratags=1&accept-language=ar&countrycodes=eg`);
            const data = await res.json();
            document.getElementById('placeName').textContent = data.display_name || 'غير متاح';
            document.getElementById('startPoint').value = data.display_name || '';
            document.getElementById('startPoint').dataset.lat = targetCoords[0];
            document.getElementById('startPoint').dataset.lon = targetCoords[1];
        } catch {
            document.getElementById('placeName').textContent = 'غير متاح';
        }
    }, (err) => {
        console.error('خطأ في تحديد الموقع:', err);
        document.getElementById('placeName').textContent = 'غير متاح';
    }, { enableHighAccuracy: true, maximumAge: 0, timeout: 3000 });
}

// إعداد نوع نقطة البداية
document.getElementById('startType').addEventListener('change', () => {
    const startType = document.getElementById('startType').value;
    const startPoint = document.getElementById('startPoint');
    if (startType === 'current') {
        startPoint.classList.add('hidden');
        startPoint.value = document.getElementById('placeName').textContent !== 'غير متاح' ? document.getElementById('placeName').textContent : '';
        startPoint.dataset.lat = userCoords ? userCoords[0] : '';
        startPoint.dataset.lon = userCoords ? userCoords[1] : '';
        document.getElementById('startSuggestions').innerHTML = '';
    } else {
        startPoint.classList.remove('hidden');
        startPoint.value = '';
        startPoint.dataset.lat = '';
        startPoint.dataset.lon = '';
    }
});

// فتح النافذة المنبثقة
document.getElementById('startJourneyBtn').addEventListener('click', () => {
    document.getElementById('journeyPopup').style.display = 'block';
});

// إغلاق النافذة المنبثقة
function closePopup() {
    document.getElementById('journeyPopup').style.display = 'none';
    document.getElementById('startType').value = 'current';
    document.getElementById('startPoint').classList.add('hidden');
    document.getElementById('startPoint').value = document.getElementById('placeName').textContent !== 'غير متاح' ? document.getElementById('placeName').textContent : '';
    document.getElementById('endPoint').value = '';
    document.getElementById('endDetails').value = '';
    document.getElementById('startSuggestions').innerHTML = '';
    document.getElementById('endSuggestions').innerHTML = '';
    document.getElementById('routeDetails').style.display = 'none';
}

// البحث التلقائي عن الأماكن (مصر فقط)
async function autocomplete(input, suggestionsDiv, isEndPoint = false) {
    const query = input.value;
    if (query.length < 3) {
        suggestionsDiv.innerHTML = '';
        return;
    }
    try {
        document.getElementById('loading').style.display = 'block';
        let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&accept-language=ar&countrycodes=eg&viewbox=24.7,22,31.7,31&bounded=1&addressdetails=1&extratags=1&limit=10`;
        if (isEndPoint && document.getElementById('endDetails').value) {
            url += `&q=${encodeURIComponent(query + ', ' + document.getElementById('endDetails').value)}`;
        }
        const res = await fetch(url);
        const data = await res.json();
        suggestionsDiv.innerHTML = '';
        data.sort((a, b) => b.importance - a.importance);
        data.forEach(place => {
            const div = document.createElement('div');
            div.textContent = place.display_name;
            div.onclick = () => {
                input.value = place.display_name;
                input.dataset.lat = place.lat;
                input.dataset.lon = place.lon;
                suggestionsDiv.innerHTML = '';
            };
            suggestionsDiv.appendChild(div);
        });
        document.getElementById('loading').style.display = 'none';
    } catch (err) {
        console.error('خطأ في البحث:', err);
        document.getElementById('loading').style.display = 'none';
    }
}

document.getElementById('startPoint').addEventListener('input', () => autocomplete(document.getElementById('startPoint'), document.getElementById('startSuggestions')));
document.getElementById('endPoint').addEventListener('input', () => autocomplete(document.getElementById('endPoint'), document.getElementById('endSuggestions'), true));
document.getElementById('endDetails').addEventListener('input', () => autocomplete(document.getElementById('endPoint'), document.getElementById('endSuggestions'), true));

// إرسال بيانات الرحلة
async function submitJourney() {
    const startType = document.getElementById('startType').value;
    const startInput = document.getElementById('startPoint');
    const endInput = document.getElementById('endPoint');

    let startCoords;
    if (startType === 'current' && userCoords) {
        startCoords = userCoords;
    } else if (startInput.dataset.lat && startInput.dataset.lon) {
        startCoords = [parseFloat(startInput.dataset.lat), parseFloat(startInput.dataset.lon)];
    } else {
        alert('يرجى اختيار نقطة بداية صالحة');
        return;
    }

    if (!endInput.dataset.lat || !endInput.dataset.lon) {
        alert('يرجى اختيار نقطة نهاية صالحة من القائمة');
        return;
    }

    const endCoords = [parseFloat(endInput.dataset.lat), parseFloat(endInput.dataset.lon)];

    try {
        document.getElementById('loading').style.display = 'block';
        const res = await fetch(`http://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson&steps=true&annotations=true`);
        const data = await res.json();
        if (data.routes && data.routes.length > 0) {
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(data.routes[0].geometry, {
                style: { color: '#0078ff', weight: 6, opacity: 0.8 }
            }).addTo(map);
            map.fitBounds(routeLayer.getBounds());

            // عرض تعليمات المسار
            const routeDetails = document.getElementById('routeDetails');
            routeDetails.innerHTML = '<h3 class="text-lg font-bold mb-2">تعليمات المسار</h3>';
            data.routes[0].legs[0].steps.forEach(step => {
                const div = document.createElement('div');
                div.className = 'text-sm mb-2';
                div.innerHTML = `${step.maneuver.instruction} (${(step.distance / 1000).toFixed(1)} كم)`;
                routeDetails.appendChild(div);
            });
            routeDetails.style.display = 'block';

            closePopup();
        } else {
            alert('لم يتم العثور على مسار');
        }
        document.getElementById('loading').style.display = 'none';
    } catch (err) {
        console.error('خطأ في حساب المسار:', err);
        alert('حدث خطأ أثناء حساب المسار');
        document.getElementById('loading').style.display = 'none';
    }
}

// اختبار مسار نموذجي (من ميدان التحرير إلى مدينة نصر)
async function loadSampleRoute() {
    const startCoords = [30.0444, 31.2357]; // ميدان التحرير
    const endCoords = [30.0661, 31.3490];   // مدينة نصر
    try {
        document.getElementById('loading').style.display = 'block';
        const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}?overview=full&geometries=geojson&steps=true&annotations=true`);
        const data = await res.json();
        if (data.routes && data.routes.length > 0) {
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(data.routes[0].geometry, {
                style: { color: '#0078ff', weight: 6, opacity: 0.8 }
            }).addTo(map);
            map.fitBounds(routeLayer.getBounds());

            const routeDetails = document.getElementById('routeDetails');
            routeDetails.innerHTML = '<h3 class="text-lg font-bold mb-2">تعليمات المسار (نموذجي)</h3>';
            data.routes[0].legs[0].steps.forEach(step => {
                const div = document.createElement('div');
                div.className = 'text-sm mb-2';
                div.innerHTML = `${step.maneuver.instruction} (${(step.distance / 1000).toFixed(1)} كم)`;
                routeDetails.appendChild(div);
            });
            routeDetails.style.display = 'block';
        }
        document.getElementById('loading').style.display = 'none';
    } catch (err) {
        console.error('خطأ في تحميل المسار النموذجي:', err);
        document.getElementById('loading').style.display = 'none';
    }
}

// تحميل المسار النموذجي عند بدء التشغيل
loadSampleRoute();
</script>

</body>
</html>
